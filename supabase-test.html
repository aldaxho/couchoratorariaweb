<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Supabase Storage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Verificaci√≥n de Supabase Storage</h1>
    
    <div class="info status">
        <strong>Proyecto Supabase:</strong> udmxynklzvmfrzhdmocp
    </div>

    <div id="results"></div>

    <h2>Acciones</h2>
    <button onclick="verificarConexion()">1. Verificar Conexi√≥n</button>
    <button onclick="listarBuckets()">2. Listar Buckets</button>
    <button onclick="crearBucket()">3. Crear Bucket 'practice-videos'</button>
    <button onclick="probarSubida()">4. Probar Subida de Video</button>

    <h2>Instrucciones Manual</h2>
    <div class="info status">
        <p><strong>Si prefieres crear el bucket manualmente:</strong></p>
        <ol>
            <li>Ve a: <a href="https://app.supabase.com/project/udmxynklzvmfrzhdmocp/storage/buckets" target="_blank">Supabase Storage</a></li>
            <li>Haz clic en "New bucket"</li>
            <li>Nombre: <code>practice-videos</code></li>
            <li>Marca como "Public bucket" ‚úÖ</li>
            <li>Haz clic en "Create bucket"</li>
        </ol>
    </div>

    <script>
        const SUPABASE_URL = 'https://udmxynklzvmfrzhdmocp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkbXh5bmtsenZtZnJ6aGRtb2NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0ODczMTEsImV4cCI6MjA3OTA2MzMxMX0.FvzXmL-oklwSXFuB7lBs0NeJmhMfDyllvO5BZWBUSgc';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const results = document.getElementById('results');

        function showResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function verificarConexion() {
            results.innerHTML = '';
            try {
                showResult('‚è≥ Verificando conexi√≥n...', 'info');
                const { data, error } = await supabase.storage.listBuckets();
                
                if (error) throw error;
                
                showResult('‚úÖ Conexi√≥n exitosa con Supabase', 'success');
                showResult(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function listarBuckets() {
            results.innerHTML = '';
            try {
                showResult('‚è≥ Listando buckets...', 'info');
                const { data, error } = await supabase.storage.listBuckets();
                
                if (error) throw error;
                
                if (data.length === 0) {
                    showResult('‚ö†Ô∏è No hay buckets creados', 'error');
                } else {
                    showResult(`‚úÖ Buckets encontrados: ${data.length}`, 'success');
                    showResult(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
                    
                    const hasPracticeVideos = data.some(b => b.name === 'practice-videos');
                    if (hasPracticeVideos) {
                        showResult('‚úÖ El bucket "practice-videos" existe', 'success');
                    } else {
                        showResult('‚ùå El bucket "practice-videos" NO existe. Cr√©alo con el bot√≥n 3.', 'error');
                    }
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function crearBucket() {
            results.innerHTML = '';
            try {
                showResult('‚è≥ Creando bucket "practice-videos"...', 'info');
                const { data, error } = await supabase.storage.createBucket('practice-videos', {
                    public: true,
                    fileSizeLimit: 524288000 // 500MB
                });
                
                if (error) {
                    if (error.message.includes('already exists')) {
                        showResult('‚úÖ El bucket ya existe', 'success');
                    } else {
                        throw error;
                    }
                } else {
                    showResult('‚úÖ Bucket creado exitosamente', 'success');
                    showResult(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
                showResult('üí° Intenta crearlo manualmente usando las instrucciones arriba', 'info');
            }
        }

        async function probarSubida() {
            results.innerHTML = '';
            try {
                showResult('‚è≥ Creando archivo de prueba...', 'info');
                
                // Crear un video de prueba (blob vac√≠o)
                const blob = new Blob(['test video content'], { type: 'video/mp4' });
                const fileName = `test-${Date.now()}.mp4`;
                const filePath = `videos/test-user/${fileName}`;

                showResult(`‚è≥ Subiendo archivo: ${filePath}...`, 'info');
                
                const { data, error } = await supabase.storage
                    .from('practice-videos')
                    .upload(filePath, blob);

                if (error) throw error;

                showResult('‚úÖ Archivo subido exitosamente', 'success');
                
                // Obtener URL p√∫blica
                const { data: urlData } = supabase.storage
                    .from('practice-videos')
                    .getPublicUrl(filePath);

                showResult(`‚úÖ URL p√∫blica: <a href="${urlData.publicUrl}" target="_blank">${urlData.publicUrl}</a>`, 'success');
                
                // Eliminar archivo de prueba
                await supabase.storage.from('practice-videos').remove([filePath]);
                showResult('‚úÖ Archivo de prueba eliminado', 'success');
                
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
                
                if (error.message.includes('not found')) {
                    showResult('‚ùå El bucket "practice-videos" no existe. Cr√©alo primero con el bot√≥n 3.', 'error');
                }
            }
        }

        // Verificar autom√°ticamente al cargar
        window.onload = () => {
            showResult('üëã Herramienta de verificaci√≥n cargada. Haz clic en los botones para probar.', 'info');
        };
    </script>
</body>
</html>
